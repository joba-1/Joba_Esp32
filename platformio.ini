; platformio.ini

[platformio]
default_envs = serial

; ============================================
; User Configuration (gitignored)
; ============================================
; Copy config.ini.template to config.ini and customize for your environment
; config.ini will be created automatically on first build if it doesn't exist
extra_configs = 
    config.ini

; ============================================
; Shared configuration for all environments
; ============================================
[env]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/54.03.20/platform-espressif32.zip
board = esp32dev
framework = arduino
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
board_build.partitions = min_spiffs.csv
board_build.filesystem = littlefs

; Pre-build script to create config.ini from template if needed
extra_scripts = pre:pre_build.py

; Library dependencies
lib_deps = 
    https://github.com/tzapu/WiFiManager.git
    ESP32Async/ESPAsyncWebServer@^3.9.5
    ESP32Async/AsyncTCP@^3.4.10
    bblanchon/ArduinoJson@^7.0.0
    knolleary/PubSubClient@^2.8

; Common build flags
build_flags = 
    ; Firmware identity
    -D FIRMWARE_NAME=\"Joba_Esp32\"
    -D FIRMWARE_VERSION=\"1.1.0\"
    -D DEVICE_INSTANCE=${user_config.device_instance}
    -D DEFAULT_PASSWORD=\"${user_config.default_password}\"
    
    ; Logging configuration
    -D LOG_BAUD_RATE=${env.monitor_speed}
    -D LOG_SERIAL_BOOT_LEVEL=${user_config.log_serial_boot_level}
    -D LOG_SERIAL_RUNTIME_LEVEL=${user_config.log_serial_runtime_level}
    -D LOG_BOOT_DURATION_MS=${user_config.log_boot_duration_ms}
    -D LOG_SYSLOG_LEVEL=${user_config.log_syslog_level}
    -D LOG_SYSLOG_SERVER=\"${user_config.log_syslog_server}\"
    -D LOG_SYSLOG_PORT=${user_config.log_syslog_port}
    -D LOG_ENABLE_TIMESTAMP=${user_config.log_enable_timestamp}
    
    ; WiFi configuration
    -D WIFI_CONFIG_PORTAL_TIMEOUT=${user_config.wifi_config_portal_timeout}
    
    ; NTP / Time configuration
    -D NTP_SERVER1=\"${user_config.ntp_server1}\"
    -D NTP_SERVER2=\"${user_config.ntp_server2}\"
    -D TIMEZONE=\"${user_config.timezone}\"
    -D NTP_SYNC_INTERVAL=${user_config.ntp_sync_interval}
    
    ; Web server configuration
    -D WEBSERVER_PORT=${user_config.webserver_port}
    -D WEBSERVER_USERNAME=\"${user_config.webserver_username}\"
    
    ; OTA configuration
    -D OTA_PORT=${user_config.ota_port}
    
    ; InfluxDB configuration (version determined by user_config.influxdb_version)
    -D INFLUXDB_URL=\"${user_config.influxdb_url}\"
    -D INFLUXDB_VERSION=${user_config.influxdb_version}
    -D INFLUXDB_DATABASE=\"${user_config.influxdb_database}\"
    -D INFLUXDB_USERNAME=\"${user_config.influxdb_username}\"
    -D INFLUXDB_PASSWORD=\"${user_config.influxdb_password}\"
    -D INFLUXDB_RP=\"${user_config.influxdb_rp}\"
    -D INFLUXDB_BATCH_INTERVAL=${user_config.influxdb_batch_interval}
    -D INFLUXDB_BATCH_SIZE=${user_config.influxdb_batch_size}
    
    ; MQTT configuration
    -D MQTT_SERVER=\"${user_config.mqtt_server}\"
    -D MQTT_PORT=${user_config.mqtt_port}
    -D MQTT_USERNAME=\"${user_config.mqtt_username}\"
    -D MQTT_PASSWORD=\"${user_config.mqtt_password}\"
    -D MQTT_RECONNECT_INTERVAL=${user_config.mqtt_reconnect_interval}
    
    ; Modbus RTU configuration
    -D MODBUS_SERIAL_RX=${user_config.modbus_serial_rx}
    -D MODBUS_SERIAL_TX=${user_config.modbus_serial_tx}
    -D MODBUS_BAUD_RATE=${user_config.modbus_baud_rate}
    -D MODBUS_SERIAL_CONFIG=${user_config.modbus_serial_config}
    -D MODBUS_DE_PIN=${user_config.modbus_de_pin}
    -D MODBUS_RESPONSE_TIMEOUT=${user_config.modbus_response_timeout}
    -D MODBUS_QUEUE_SIZE=${user_config.modbus_queue_size}
    -D MODBUS_DEVICE_TYPES_PATH=\"${user_config.modbus_device_types_path}\"
    -D MODBUS_DEVICE_MAP_PATH=\"${user_config.modbus_device_map_path}\"
    -D MODBUS_STATS_INTERVAL_MS=${user_config.modbus_stats_interval_ms}
    -D MODBUS_OWN_FAIL_WARN_PERCENT=${user_config.modbus_own_fail_warn_percent}
    -D MODBUS_OTHER_FAIL_WARN_PERCENT=${user_config.modbus_other_fail_warn_percent}
    -D MODBUS_BUS_BUSY_WARN_PERCENT=${user_config.modbus_bus_busy_warn_percent}
    -D MODBUS_LISTEN_ONLY=${user_config.modbus_listen_only}
        
    ; LED indicator configuration
    -D LED_PIN=${user_config.led_pin}
    -D LED_ACTIVE_LOW=${user_config.led_active_low}
    -D LED_PULSE_DURATION=${user_config.led_pulse_duration}

; ============================================
; Serial upload environment
; ============================================
[env:serial]
upload_protocol = esptool
upload_port = ${user_config.upload_port_serial}

; ============================================
; OTA upload environment
; ============================================
[env:ota]
upload_protocol = espota
; upload_port from user config or specify directly
upload_port = ${user_config.upload_port_ota}
upload_flags = 
    --timeout=30
    --port=${user_config.ota_port}
    --auth=${user_config.upload_password_ota}

